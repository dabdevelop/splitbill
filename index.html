<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/naslogo.png">

    <title>星云支付</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/toolkit-light.css" rel="stylesheet">
    <link href="css/docs.css" rel="stylesheet">
    <link href="css/application.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/form-validation.css" rel="stylesheet">

    <!-- Loading CSS -->
    <link rel="stylesheet" type="text/css" href="css/loading.css">
    <link rel="stylesheet" type="text/css" href="css/loading-btn.css">


    <!-- Import Javascript -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/nebulas.js"></script>
    <script src="js/nebPay.js"></script>
    <script src="js/dappConfig.js"></script>
    <script src="js/nebConfig.js"></script>
    <script src="js/mustache.min.js"></script>
    <script src="js/bignumber.min.js"></script>
</head>

<body class="bg-light">

<div class="container">
    <div class="py-5 text-center">
        <a href="index.html"><img class="d-block mx-auto mb-4" src="img/naspay.png" alt="星云支付" width="228px" height="48px"></a>

        <a href="index.html"class="text-dark"><h2 >星云支付</h2></a>

        <p class="lead">星云支付收付款服务供您免费使用</p>
    </div>

    <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
            <div class="bill-panel">
            <div class="bqe">
                <input class="form-control" type="text" placeholder="搜索..." id="addressSearch">
                <button id="searchBTN" class="nz" onclick="search()">
                    <span class="bv bhw"></span>
                </button>
            </div>
            <h4 class="d-flex justify-content-between align-items-center mb-3  panel-heading" onclick="toggleDiv('initiatorBillDiv')">
                <span class="text-muted">您的收款项</span>
                <span class="badge badge-secondary badge-pill" id="initiatorBillNum">0</span>
            </h4>
            <div id="initiatorBillDiv">
                <ul class="list-group mb-3" id="initiatorBillList">
                </ul>
            </div>
            </div>

            <div class="bill-panel">
                <h4 class="d-flex justify-content-between align-items-center mb-3 panel-heading"  onclick="toggleDiv('receiverBillDiv')">
                    <span class="text-muted">您的待提款</span>
                    <span class="badge badge-secondary badge-pill" id="receiverBillNum">0</span>
                </h4>
                <div id="receiverBillDiv">
                <ul class="list-group mb-3" id="receiverBillList">
                </ul>
                </div>
            </div>

            <div class="bill-panel">
                <h4 class="d-flex justify-content-between align-items-center mb-3  panel-heading" onclick="toggleDiv('takerBillDiv')">
                    <span class="text-muted">您的已提款</span>
                    <span class="badge badge-secondary badge-pill" id="takerBillNum">0</span>
                </h4>
                <div id="takerBillDiv">
                <ul class="list-group mb-3" id="takerBillList">
                </ul>
                </div>
            </div>

            <div class="bill-panel">
                <h4 class="d-flex justify-content-between align-items-center mb-3 panel-heading" onclick="toggleDiv('payerBillDiv')">
                    <span class="text-muted">您的已付款</span>
                    <span class="badge badge-secondary badge-pill" id="payerBillNum">0</span>
                </h4>
                <div id="payerBillDiv">
                <ul class="list-group mb-3" id="payerBillList">
                </ul>
                </div>
            </div>

            <div class="paid-panel" id="paid-panel" hidden="hidden">
                <h4 class="d-flex justify-content-between align-items-center mb-3 panel-heading" onclick="toggleDiv('paidBillDiv')">
                    <span class="text-muted">付款人列表</span>
                    <span class="badge badge-secondary badge-pill" id="paidBillNum">0</span>
                </h4>
                <div id="paidBillDiv">
                </div>
            </div>


        </div>

        <div class="col-md-8 order-md-1">
            <h4 class="mb-3">收款项信息</h4>

            <form id="billForm" class="needs-validation" novalidate>

                <div class="mb-3">
                    <label for="billName">收款项目</label>
                    <input type="text" class="form-control" id="billName" placeholder="收款项目名称" required>

                    <div class="invalid-feedback">
                        请输入收款项目名称。
                    </div>
                </div>


                <div class="mb-3">
                    <label for="initiatorName">发起人</label>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">@</span>
                        </div>
                        <input type="text" class="form-control" id="initiatorName" placeholder="发起人名称" value=""
                               required>

                        <div class="invalid-feedback" style="width: 100%;">
                            请输入收款项目发起人名称。
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="receiverName">收款人<span class="text-muted">(可选)</span></label>
                        <input type="text" class="form-control" id="receiverName" placeholder="默认为发起人" value="">

                        <div class="invalid-feedback">
                            请输入收款项目收款人名称。
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="receiverAcc">收款账号<span class="text-muted">(可选)</span></label>
                        <input type="text" class="form-control" id="receiverAcc" placeholder="默认为发起账号" value="">

                        <div class="invalid-feedback">
                            请输入收款项目收款人星云链账户地址。
                        </div>
                    </div>
                </div>

                <hr class="mb-4">

                <h4 class="mb-3">货币单位</h4>

                <div class="d-block my-3">
                    <div class="custom-control custom-radio">
                        <input id="nas" name="unit" type="radio" class="custom-control-input" value="nas" checked
                               required>
                        <label class="custom-control-label" for="nas">星云币<span class="text-muted">(NAS)</span></label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input id="cny" name="unit" type="radio" class="custom-control-input" value="cny" required>
                        <label class="custom-control-label" for="cny">人民币<span class="text-muted">(CNY)</span></label>
                    </div>
                    <div class="custom-control custom-radio">
                        <input id="usd" name="unit" type="radio" class="custom-control-input" value="usd" required>
                        <label class="custom-control-label" for="usd">美元<span class="text-muted">(USD)</span></label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="amount" id="payAmount">总金额</label>
                    <input type="number" step="0.01" class="form-control" name="amount" id="amount" placeholder="收款项目总金额" value="0"
                           required>
                    <div class="invalid-feedback">
                        请输入收款项目总金额。
                    </div>
                </div>

                <div class="mb-3">
                    <label for="num" id="payNum">付款人数</label>
                    <input type="number" class="form-control" name="num" id="num" placeholder="付款人数" value="0" required>
                    <div class="invalid-feedback">
                        请输入付款人数。
                    </div>
                </div>

                <div class="mb-3">
                    <label for="average">人均支付</label>
                    <input type="text" class="form-control" id="average" value="0" readonly>
                </div>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="canTakeout" name="canTakeout"
                           checked="checked">
                    <label class="custom-control-label" for="canTakeout">开通收款人取款权限</label>
                </div>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="unconstrainedAmount">
                    <label class="custom-control-label" for="unconstrainedAmount">不指定付款金额</label>
                </div>

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="unlimitedAmount" name="unlimitedAmount">
                    <label class="custom-control-label" for="unlimitedAmount">收款项目不限总金额</label>
                </div>

                <div class="mb-3"  id="payAmountDiv" hidden="hidden">
                    <label for="unconstrainedPayAmount">付款金额</label>
                    <input type="number" step="0.01" class="form-control" name="amount" id="unconstrainedPayAmount" placeholder="付款金额" value=""
                           required>
                    <div class="invalid-feedback">
                        请输入付款金额。
                    </div>
                </div>

                <div class="mb-3" id="memoDiv" hidden="hidden">
                    <label for="memo">备注信息</label>
                    <input type="text" class="form-control" name="memo" id="memo" placeholder="备注信息" value="">
                    <div class="invalid-feedback">
                        请输入付款备注信息。
                    </div>
                </div>

            </form>
            <hr class="mb-4">
            <button class="btn btn-primary btn-lg btn-block" id="submit" onclick="newSplitBill()"></button>
        </div>
    </div>

    <footer class="my-5 pt-5 text-muted text-center text-small">
        <p class="mb-1">&copy; 2018 星云支付</p>
        <ul class="list-inline">
            <li class="list-inline-item"><a href="https://nebulas.io" target="_blank">星云官方网站</a></li>
            <li class="list-inline-item"><a href="https://explorer.nebulas.io" target="_blank">星云区块浏览器</a></li>
            <li class="list-inline-item"><a href="https://github.com/ChengOrangeJu/WebExtensionWallet" target="_blank">星云钱包插件</a>
            </li>
            <li class="list-inline-item"><a href="https://github.com/dabdevelop/splitbill"
                                            target="_blank">项目GitHub源码</a></li>
            <li class="list-inline-item"><a href="" id="contract">合约地址</a></li>
            <li class="list-inline-item"><a href="faucet.html" target="_blank">NAS水龙头</a></li>
        </ul>
    </footer>
</div>


<script>
    function toggleDiv(divId) {
        $("#"+divId).toggle();
    }
    $("#initiatorBillDiv").toggle();
    $("#receiverBillDiv").toggle();
    $("#takerBillDiv").toggle();
    $("#payerBillDiv").toggle();

    var chainId = 1;
    var rpcURL = "https://mainnet.nebulas.io";
    var dappAddress = "n1pjws9vkbfBrwNks9HmaJgYa4TjC7iMEGm";
    if(chainId == 1){
        $("#contract").prop('href','https://explorer.nebulas.io/#/address/'+ dappAddress +'#/').prop('target', '_blank_');
    } else {
        $("#contract").prop('href','https://explorer.nebulas.io/#/testnet/address/'+ dappAddress +'#/').prop('target', '_blank_');
    }
</script>

<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/holder.min.js"></script>
<script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict';

        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');

            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
</script>

<style>
    a:hover, a:visited, a:link, a:active{
        text-decoration: none;
    }
</style>

<script>

    'use strict';

    var Nebulas = require("nebulas");
    var Account = Nebulas.Account;
    var Transaction = Nebulas.Transaction;
    var Utils = Nebulas.Utils;
    var Unit = Nebulas.Unit;

    var neb = new Nebulas.Neb();
    neb.setRequest(new Nebulas.HttpRequest(rpcURL));

    var CNY = 0;
    var USD = 0;
    var UNIT = 'nas';
    var rate = {nas: 1, cny: CNY, usd: USD};
    var canTakeout = true;

    function getConversionRate(callback) {
        $.get("https://api.coinmarketcap.com/v2/ticker/1908/?convert=CNY", function (data) {
            CNY = parseFloat(data.data.quotes.CNY.price);
            USD = parseFloat(data.data.quotes.USD.price);
            rate['nas'] = 1;
            rate['cny'] = CNY;
            rate['usd'] = USD;
            callback();
        });

    }
    var amount = $("#amount");
    var average = $("#average");
    var num = $("#num");

    $("input[name='unit']").change(function () {
        getConversionRate(function () {
            var P_UNIT = UNIT;
            UNIT = $("input[name='unit']:checked").val();
            amount.val(parseFloat(amount.val()) * rate[UNIT] / rate[P_UNIT]);
            if (parseInt(num.val()) == 0) {
                $("#average").val(0);
            } else {
                num.val(parseInt(num.val()));
                $("#average").val(parseFloat(amount.val()) / parseInt(num.val()));
            }
        });
    });

    amount.on('input', function (e) {
        if (parseFloat(amount.val()) <= 0) {
            average.val(0);
            amount.val(0);
            num.val(0);
            $("#unlimitedAmount").prop("checked", true);
            $("#unconstrainedAmount").prop("checked", true);
            num.prop("readonly", true);
        } else if (parseInt(num.val()) > 0) {
            num.prop("readonly", false);
            $("#unlimitedAmount").prop("checked", false);
            if(Math.floor(parseFloat(amount.val()) * 1000) < parseFloat(amount.val()) * 1000 ){
                amount.val((Math.floor(parseFloat(amount.val()) * 1000) / 1000.0));
            }
            num.val(parseInt(num.val()));
            average.val(parseFloat(amount.val()) / parseInt(num.val()));
        } else {
            num.prop("readonly", false);
            $("#unlimitedAmount").prop("checked", false);
        }
    });

    num.on('input', function (e) {
        if (parseInt(num.val()) <= 0) {
            average.val(0);
            num.val(0);
            $("#unconstrainedAmount").prop("checked", true);
        } else if (parseInt(num.val()) > 0) {
            if(parseFloat(amount.val()) > 0)
            $("#unconstrainedAmount").prop("checked", false);
            num.val(parseInt(num.val()));
            average.val(parseFloat(amount.val()) / parseInt(num.val()));
        }
    });

    $('#canTakeout').click(function () {
        if(action === 'pay' || action === 'view' || action === 'takeout'){
            $('#canTakeout').prop('checked', canTakeout);
        } else{
            canTakeout = !!$(this).is(':checked');
        }
    });

    $('#unlimitedAmount').click(function () {
        if ($(this).is(':checked')) {
            amount.val(0);
            num.val(0);
            average.val(0);
            $('#unconstrainedAmount').prop('checked', true).prop('disabled', true);
            num.prop('readonly', true);
            amount.prop('readonly', true);
        } else {
            $('#unconstrainedAmount').prop('checked', false).prop('disabled', false);
            num.prop('readonly', false);
            amount.prop('readonly', false);
        }
    });

    $('#unconstrainedAmount').click(function () {
        if ($(this).is(':checked')) {
            num.val(0);
            average.val(0);
            num.prop('readonly', true);
        } else {
            num.prop('readonly', false);
        }
    });

    var unconstrainedPayAmount = $("#unconstrainedPayAmount");
    var submit = $("#submit");

    unconstrainedPayAmount.on('input', function (e) {
        if (parseFloat(unconstrainedPayAmount.val()) < 0) {
            unconstrainedPayAmount.val(0);
            submit.val('请输入付款金额').prop('disabled', true);
        } else if (parseFloat(unconstrainedPayAmount.val()) > 0) {
            if(unconstrainedPayAmount.val().startsWith('0') && !unconstrainedPayAmount.val().startsWith('0.'))
                unconstrainedPayAmount.val(parseFloat(unconstrainedPayAmount.val()));
            submit.html("确认付款 " + parseFloat(unconstrainedPayAmount.val()) + ' NAS').prop('disabled', false).prop("onclick", null).off('click').click(function(){
                if(parseFloat(unconstrainedPayAmount.val()) > 0)
                    pay(index, $("#unconstrainedPayAmount").val(), $('#memo').val().trim()); });
        } else if (unconstrainedPayAmount.val() === '') {
            submit.prop('disabled', true);
            submit.val('请输入付款金额');
        }
    });

    $("#addressSearch").keyup(function(event) {
        if (event.keyCode === 13) {
            $("#searchBTN").click();
        }
    });

    var needCheckNASWallet = true;
    var invoker = null;

    function checkNASWallet(_invoker) {
        invoker = _invoker;
        //to check if the extension is installed
        //if the extension is installed, var "webExtensionWallet" will be injected in to web page
        if (needCheckNASWallet && (typeof (webExtensionWallet) === "undefined")) {
            $(document).ready(function () {
                if(window.mobileAndTabletcheck()){
                    $("#noWalletMobile").modal('show');
                } else{
                    $("#noWallet").modal('show');
                }

            });
            return false;
        }
        return true;
    }

    function disableCheckNASWallet() {
        needCheckNASWallet = false;
        if(invoker != null){
            invoker.click();
        }
    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getTransactionReceipt(hash, callback){
        $.post(rpcURL + '/v1/user/getTransactionReceipt', JSON.stringify({
            "hash": hash
        }), function (resp) {
            callback(resp)
        })
    }


    function recheckTransactionReceipt(hash, callback) {
        var retry = 8;
        var retry2 = 32;
        var task = setInterval(function () {
            getTransactionReceipt(hash, function (resp) {
                retry --;
                if(retry < 0){

                    try{
                        neb.api.getTransactionReceipt({hash: hash}).then(function(receipt){
                            if (receipt.status == 0) //not in pending
                            {
                                $('#packing').modal('hide');
                                clearInterval(task);
                                var fail = $('#fail');
                                var fail_link = $('#fail_link');
                                if(chainId == 1){
                                    fail_link.prop('href','https://explorer.nebulas.io/#/address/'+ dappAddress +'#/').prop('target', '_blank_');
                                } else {
                                    fail_link.prop('href','https://explorer.nebulas.io/#/testnet/address/'+ dappAddress +'#/').prop('target', '_blank_');
                                }
                                fail.modal('show');
                            } else if (receipt.status == 2) {
                                retry2 --;
                                if(retry2 < 0){
                                    clearInterval(task);
                                    var query_overtime = $('#query_overtime');
                                    var query_link = $('#query_link');
                                    if(chainId == 1){
                                        query_link.prop('href','https://explorer.nebulas.io/#/address/'+ dappAddress +'#/').prop('target', '_blank_');
                                    } else {
                                        query_link.prop('href','https://explorer.nebulas.io/#/testnet/address/'+ dappAddress +'#/').prop('target', '_blank_');
                                    }
                                    query_overtime.modal('show');
                                }
                            } else {
                                clearInterval(task);
                                callback(resp);
                            }
                        });
                    } catch(err){
                        console.log(err);
                    }
                }
                var status = resp.result.status;
                if(status == 1){
                    clearInterval(task);
                    callback(resp);
                }
            })
        }, 1000);
    }

    function innerCall(fun, args, value, callback) {
        let params = {};
        var account = Account.NewAccount();
        account.setPrivateKey(faucets[getRandomInt(0, 100)]);
        params.from = account;
        params.to = dappAddress;
        params.gasPrice = Utils.toBigNumber(1000000);
        params.gasLimit = Utils.toBigNumber(2000000);
        params.value = value;
        // prepare contract
        params.contract = {
            "function": fun,
            "args": JSON.stringify(args)
        };
//        console.log(params.from.getAddressString() + ' call ' + params.to + ' @ ' + fun + ": " + JSON.stringify(args) + ' with value: ' + value);
        callback(params);
    }

    window.mobileAndTabletcheck = function() {
        var check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
    };

    function refresh(){
        window.location.href = window.location.href;
    }

    var packingRefreshShowed = false;

    function funcIntervalQuery(callback) {
        nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
                .then(function (resp) {
                    var respObject = JSON.parse(resp);
                    if(!packingRefreshShowed){
                        packingRefreshShowed = true;
                        $('#confirm').modal('hide');
                        $('#packing_refresh').modal('show');
                    }
                    function clearWait() {
                        clearInterval(wait);
                        window.location.href = window.location.href;
                    }
                    if(respObject.code === 0){
                        clearInterval(intervalQuery);
                        var wait = setInterval(clearWait, 3000);
                    }
                })
                .catch(function (err) {
                    console.log(err);
                });
    }

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber;
    var intervalQuery;

    function callNebPay(fun, args, value, callback) {
        $('#confirm').modal('show');
        innerCall(fun, args, value, function (params) {
            serialNumber = nebPay.call(params.to, params.value, params.contract.function, params.contract.args, {
                listener: function (resp) {
                    $('#confirm').modal('hide');
                    if (resp !== 'Error: Transaction rejected by user') {
                        $('#packing').modal('show');
                        var hash = resp.txhash;
                        recheckTransactionReceipt(hash, function (resp) {
                            $('#packing').modal('hide');
                            $('#packing_success').modal('show');
                            callback(resp);
                        })
                    } else {
                        $('#reject').modal('show');
                    }

                }
            });

            if(window.mobileAndTabletcheck()){
                $('#confirm').modal('hide');
                packingRefreshShowed = false;
                intervalQuery = setInterval(function () {
                    funcIntervalQuery(callback);
                }, 5000);
            }


        });
    }


    function validateInput() {
        var billForm = $("#billForm");
        billForm.removeClass('was-validated');
        if ($("#billName").val().trim() === '' || $("#initiatorName").val().trim() === '') {
            billForm.addClass('was-validated');
            return false;
        }
        return true;
    }

    function newSplitBill() {
        if (validateInput()) {
            if (checkNASWallet(submit)) {
                //_billName, _receiverName, _receiverAcc, _initiatorName, _amount, _splitNum, _canTakeOut
                var fun = 'newSplitBill';
                var args = [];
                args.push($("#billName").val().trim());
                args.push($("#receiverName").val().trim());
                var receiverAcc = $("#receiverAcc").val().trim();
                if(receiverAcc === "" || Account.isValidAddress(receiverAcc)){
                    args.push(receiverAcc);
                    args.push($("#initiatorName").val().trim());
                    args.push((parseFloat($("#amount").val()) / rate[UNIT] * rate['nas']).toFixed(8));
                    args.push(parseInt($("#num").val()));
                    args.push(canTakeout);
                    var value = 0;
                    callNebPay(fun, args, value, function(resp){
                        function clearWait() {
                            clearInterval(wait);
                            window.location.href = window.location.protocol + '//' + window.location.host + window.location.pathname+ "?index="+ resp.result.execute_result +"&action=pay&address=" + resp.result.from;
                        }
                        var wait = setInterval(clearWait, 2000);
                    });
                } else {
                    $("#receiverAcc").val('');
                    $('#invalidAddress').modal('show');
                }
            }
        }
    }

    function search(){
        var addressSearch = $("#addressSearch");
        if(parseInt(addressSearch.val()) >= 0){
            window.location.href = window.location.protocol + '//' + window.location.host + window.location.pathname+ "?index="+ parseInt(addressSearch.val()) +"&action=pay&address=" + addressWallet;
        } else if(Account.isValidAddress(addressSearch.val())){
            window.location.href = window.location.protocol + '//' + window.location.host + window.location.pathname+ "?address=" + addressSearch.val();
        } else {
            addressSearch.val('');
            $('#invalidSearch').modal('show');
        }
    }


    //    setCanTakeout

    function pay(index, value, memo){
        if (checkNASWallet(submit)) {
            var fun = 'pay';
            var args = [];
            args.push(index);
            args.push(memo);
            callNebPay(fun, args, value, function (resp) {
                function clearWait() {
                    clearInterval(wait);
                    window.location.href = window.location.protocol + '//' + window.location.host + window.location.pathname + "?index=" + index +"&action=view&address=" + resp.result.from;
                }
                var wait = setInterval(clearWait, 2000);

            });
        }
    }

    function takeout(index, amount){
        if (checkNASWallet(submit)) {
            var fun = 'takeout';
            var args = [];
            args.push(index);
            args.push(amount);
            var value = 0;
            callNebPay(fun, args, value, function (resp) {
                function clearWait() {
                    clearInterval(wait);
                    window.location.href = window.location.protocol + '//' + window.location.host + window.location.pathname + "?index=" + index +"&action=takenOut&address=" + resp.result.from;
                }
                var wait = setInterval(clearWait, 2000);

            });
        }
    }

    function setCanTakeout(index, can){
        if (checkNASWallet($('#canTakeout'))) {
            var fun = 'setCanTakeout';
            var args = [];
            args.push(index);
            args.push(can);
            var value = 0;
            $('#canTakeout').prop('checked', canTakeout);
            callNebPay(fun, args, value, function (resp) {
                $('#canTakeout').prop('checked', canTakeout);
                function clearWait() {
                    clearInterval(wait);
                    window.location.href = window.location.href;
                }
                var wait = setInterval(clearWait, 2000);

            });
        }
        $('#canTakeout').prop('checked', canTakeout);
    }

    var address = '';
    var addressWallet = '';
    var initiatorBL = $("#initiatorBillList");
    function addInitiatorBill(bills){
        $("#initiatorBillNum").html(bills.length);
        for(var i in bills){
            if(address !== ''){
                var fun = 'getBillByIndex';
                var args = [];
                args.push(bills[i]);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null' || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            var skeleton;
                            var data;
                            skeleton = '<a href="index.html?index={{index}}&action={{action}}&address={{address}}" class="text-{{color}}"><li class="list-group-item d-flex justify-content-between lh-condensed pu rs xj ux"><div><h6 class="my-0  text-{{color}}">{{billName}}</h6><small class="text-{{color}}">{{paidNum}}人已付款{{paid}}NAS</small></div><span class="text-{{color}}">{{amount}} NAS</span></li></a>';
                            data = {index: parseInt(result.id), action: 'pay', address: address, billName: result.billName, paidNum: result.paidNum, paid: Unit.fromBasic(result.paid, "nas"), amount: Unit.fromBasic(result.amount, "nas"), color: 'primary'};
                            var html = Mustache.to_html(skeleton, data);
                            var added = [];
                            if(initiatorBL.val() !== ''){
                                added = JSON.parse(initiatorBL.val());
                            }
                            if(!added.includes(parseInt(result.id))){
                                added.push(parseInt(result.id));
                                initiatorBL.val(JSON.stringify(added));
                                initiatorBL.append(html);
                            }
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }
        }
    }

    function getInitiatorBill(){
        window.addEventListener('message', function (e) {
            if (e.data.data && !!e.data.data.account) {
                if(address === '') address = e.data.data.account;
                addressWallet = e.data.data.account;
            }
            if(address !== ''){
                var fun = 'getInitiatorBill';
                var args = [];
                args.push(address);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null' || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            addInitiatorBill(result);
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        console.log("error:" + err.message)
                    });

                });
            }
        });

        window.postMessage({
            "target": "contentscript",
            "data": {},
            "method": "getAccount",
        }, "*");

    }

    var receiverBL = $("#receiverBillList");
    function addReceiverBill(bills){
        for(var i in bills){
            if(address !== ''){
                var fun = 'getBillByIndex';
                var args = [];
                args.push(bills[i]);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null'  || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            var skeleton;
                            var data;
                            var toTake = Unit.fromBasic(new BigNumber(result.paid).minus(new BigNumber(result.takenOut)), "nas");
                            if(result.validLimit){
                                toTake = Math.min(Unit.fromBasic(result.takeOutLimit, "nas"), toTake);
                            }
                            skeleton = '<a href="index.html?index={{index}}&action={{action}}&address={{address}}" class="text-{{color}}"><li class="list-group-item d-flex justify-content-between lh-condensed pu rs xj ux"><div><h6 class="my-0 text-{{color}}">{{billName}}</h6><small class="text-{{color}}">{{amountToTakeout}}NAS等待提款</small></div><span class="text-{{color}}">{{amount}} NAS</span></li></a>';
                            data = {index: parseInt(result.id), action: 'takeout', address: address, billName: result.billName, amountToTakeout: toTake, paidNum: result.paidNum, paid: Unit.fromBasic(result.paid, "nas"), amount: Unit.fromBasic(result.amount, "nas"), color: 'success'};
                            var html = Mustache.to_html(skeleton, data);
                            var added = [];
                            if(receiverBL.val() !== ''){
                                added = JSON.parse(receiverBL.val());
                            }
                            if(!added.includes(parseInt(result.id)) && toTake > 0 && result.receiverAcc === address){
                                added.push(parseInt(result.id));
                                receiverBL.val(JSON.stringify(added));
                                receiverBL.append(html);
                            }
                            $("#receiverBillNum").html($("#receiverBillList li").length);
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }
        }
    }

    function getReceiverBill(){
        window.addEventListener('message', function (e) {
            if (e.data.data && !!e.data.data.account) {
                if(address === '') address = e.data.data.account;
                addressWallet = e.data.data.account;
            }

            if(address !== ''){
                var fun = 'getReceiverBill';
                var args = [];
                args.push(address);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null' || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            addReceiverBill(result);
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }

        });

        window.postMessage({
            "target": "contentscript",
            "data": {},
            "method": "getAccount",
        }, "*");

    }

    var takerBL = $("#takerBillList");
    function addTakerBill(bills){
        $("#takerBillNum").html(bills.length);
        for(var i in bills){
            if(address !== ''){
                var fun = 'getBillByIndex';
                var args = [];
                args.push(bills[i]);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null'  || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            var skeleton;
                            var data;
                            skeleton = '<a href="index.html?index={{index}}&action={{action}}&address={{address}}" class="text-{{color}}"><li class="list-group-item d-flex justify-content-between lh-condensed pu rs xj ux"><div><h6 class="my-0 text-{{color}}">{{billName}}</h6><small class="text-{{color}}">已提款{{takenOut}}NAS</small></div><span class="text-{{color}}">{{amount}} NAS</span></li></a>';
                            data = {index: parseInt(result.id), action: 'takenOut', address: address, billName: result.billName, paidNum: result.paidNum, takenOut: Unit.fromBasic(result.takenAccs[address], "nas"), amount: Unit.fromBasic(result.amount, "nas"), color: 'info'};
                            var html = Mustache.to_html(skeleton, data);
                            var added = [];
                            if(takerBL.val() !== ''){
                                added = JSON.parse(takerBL.val());
                            }
                            if(!added.includes(parseInt(result.id))){
                                added.push(parseInt(result.id));
                                takerBL.val(JSON.stringify(added));
                                takerBL.append(html);
                            }
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }
        }
    }


    function getTakerBill(){
        window.addEventListener('message', function (e) {
            if (e.data.data && !!e.data.data.account) {
                if(address === '') address = e.data.data.account;
                addressWallet = e.data.data.account;
            }

            if(address !== ''){
                var fun = 'getTakerBill';
                var args = [];
                args.push(address);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null' || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            addTakerBill(result);
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }
        });

        window.postMessage({
            "target": "contentscript",
            "data": {},
            "method": "getAccount",
        }, "*");

    }


    var payerBL = $("#payerBillList");
    function addPayerBill(bills){
        $("#payerBillNum").html(bills.length);
        for(var i in bills){
            if(address !== ''){
                var fun = 'getBillByIndex';
                var args = [];
                args.push(bills[i]);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null' || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            var skeleton;
                            var data;
                            skeleton = '<a href="index.html?index={{index}}&action={{action}}&address={{address}}" class="text-{{color}}"><li class="list-group-item d-flex justify-content-between lh-condensed pu rs xj ux"><div><h6 class="my-0 text-{{color}}">{{billName}}</h6><small class="text-{{color}}">已付款{{paid}}NAS</small></div><span class="text-{{color}}">{{amount}} NAS</span></li></a>';
                            data = {index: parseInt(result.id), action: 'view', address: address, billName: result.billName, paidNum: result.paidNum, paid: Unit.fromBasic(result.paidAccs[address], "nas"), amount: Unit.fromBasic(result.amount, "nas"), color: 'warning'};
                            var html = Mustache.to_html(skeleton, data);
                            var added = [];
                            if(payerBL.val() !== ''){
                                added = JSON.parse(payerBL.val());
                            }
                            if(!added.includes(parseInt(result.id))){
                                added.push(parseInt(result.id));
                                payerBL.val(JSON.stringify(added));
                                payerBL.append(html);
                            }
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }
        }
    }

    function getPayerBill(){
        window.addEventListener('message', function (e) {
            if (e.data.data && !!e.data.data.account) {
                if(address === '') address = e.data.data.account;
                addressWallet = e.data.data.account;
            }

            if(address !== ''){
                var fun = 'getPayerBill';
                var args = [];
                args.push(address);
                innerCall(fun, args, 0, function(params){
                    neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                        var result = resp.result;
                        if(result === 'null' || result === '""'){
                            return;
                        }
                        try{
                            result = JSON.parse(result);
                            addPayerBill(result);
                        }catch (err){
                            //result is the error message
                            console.log("error:" + err.message)
                        }

                    }).catch(function (err) {
                        //cbSearch(err)
                        console.log("error:" + err.message)
                    });

                });
            }
        });

        window.postMessage({
            "target": "contentscript",
            "data": {},
            "method": "getAccount",
        }, "*");

    }

    var noBillShowed = false;
    var paidBill = $("#paidBillDiv");
    var paidBillNum = $("#paidBillNum");

    function getSplitBill(index, callback){
        var fun = 'getBillByIndex';
        var args = [];
        args.push(index);
        innerCall(fun, args, 0, function(params){
            neb.api.call(params.from.getAddressString(), params.to, params.value, 0, params.gasPrice, params.gasLimit, params.contract).then(function (resp) {
                var result = resp.result;
                if(result === 'null' || result === '""'){
                    if(!noBillShowed){
                        noBillShowed = true;
                        $("#no_bill").modal('show');
                    }
                    return;
                }

                try{
                    result = JSON.parse(result);
                    $("#billName").val(result.billName);
                    $("#initiatorName").val(result.initiatorName);
                    $("#receiverName").val(result.receiverName);
                    $("#receiverAcc").val(result.receiverAcc);
                    $("#payAmount").html( '总金额: (' + Unit.fromBasic(result.paid, 'nas') +' NAS已付)');
                    $("#amount").val(Unit.fromBasic(result.amount, 'nas'));
                    $("#payNum").html('付款人数: (' + result.paidNum +'人已付)' );
                    $("#num").val(result.splitNum);
                    $("#average").val(Unit.fromBasic(result.billEach, 'nas'));

                    if(action === 'pay'){
                        if(result.amount != 0 && (new BigNumber(result.amount).lte(new BigNumber(result.paid)) || result.ended)){
                            submit.html("收款项已结束，完成收款 "  + Unit.fromBasic(result.paid, 'nas') + ' NAS').prop('disabled', true);
                        } else if(result.billEach > 0){
                            if(addressWallet !== '' && typeof (result.paidAccs[addressWallet]) != 'undefined' && new BigNumber(result.paidAccs[addressWallet]).gte(new BigNumber(result.billEach))){
                                submit.html("已付款 " + Unit.fromBasic(result.paidAccs[addressWallet], 'nas') + ' NAS').prop('disabled', true);
                            } else {
                                if(Math.ceil(Unit.fromBasic(result.billEach, 'nas') * Math.pow(10, 8)) > Unit.fromBasic(result.billEach, 'nas') * Math.pow(10, 8)){
                                    unconstrainedPayAmount.val(Math.ceil(Unit.fromBasic(result.billEach, 'nas') * Math.pow(10, 8)) / Math.pow(10, 8));
                                    submit.html("确认付款 "  + Math.ceil(Unit.fromBasic(result.billEach, 'nas') * Math.pow(10, 8)) / Math.pow(10, 8) + ' NAS').prop('disabled', true);
                                    $("#submit").prop('disabled', false).prop("onclick", null).off('click').click(function(){ pay(parseInt(result.id), Math.ceil(Unit.fromBasic(result.billEach, 'nas') * Math.pow(10, 8)) / Math.pow(10, 8), $('#memo').val().trim()); });
                                } else {
                                    unconstrainedPayAmount.val(Unit.fromBasic(result.billEach, 'nas'));
                                    submit.html("确认付款 "  + Unit.fromBasic(result.billEach, 'nas') + ' NAS').prop('disabled', true);
                                    $("#submit").prop('disabled', false).prop("onclick", null).off('click').click(function(){ pay(parseInt(result.id), Unit.fromBasic(result.billEach, 'nas'), $('#memo').val().trim()); });

                                }
                            }
                        } else if(parseFloat(unconstrainedPayAmount.val()) > 0){
                            if(unconstrainedPayAmount.val().startsWith('0'))
                                unconstrainedPayAmount.val(parseFloat(unconstrainedPayAmount.val()));
                            if(Math.ceil(parseFloat(unconstrainedPayAmount.val()) * Math.pow(10, 8)) > parseFloat(unconstrainedPayAmount.val()) * Math.pow(10, 8))
                                unconstrainedPayAmount.val(Math.ceil(parseFloat(unconstrainedPayAmount.val()) * Math.pow(10, 8)) / Math.pow(10, 8));
                            submit.html("确认付款 " + parseFloat(unconstrainedPayAmount.val()) + ' NAS').prop('disabled', false).prop("onclick", null).off('click').click(function(){
                                if(parseFloat(unconstrainedPayAmount.val()) > 0)
                                    pay(index, $("#unconstrainedPayAmount").val(), $('#memo').val().trim()); });
                        } else  if (unconstrainedPayAmount.val() === '')  {
                            submit.html("请输入付款金额").prop('disabled', true);
                        }
                    } else if(action === 'takeout'){
                        if(result.canTakeOut){
                            if(addressWallet !== '' && result.receiverAcc !== addressWallet){
                                submit.html("您没有提款权限").prop('disabled', true);
                            } else {
                                if(new BigNumber(result.paid).gt(new BigNumber(result.takenOut))){
                                    submit.html("确认提款 " + Unit.fromBasic(new BigNumber(result.paid).minus(new BigNumber(result.takenOut)), 'nas') + ' NAS').prop('disabled', false);
                                    submit.prop('disabled', false).prop("onclick", null).off('click').click(function(){ takeout(parseInt(result.id), Unit.fromBasic(new BigNumber(result.paid).minus(new BigNumber(result.takenOut)), 'nas')) ; });
                                } else {
                                    submit.html("您已提款 " + Unit.fromBasic(new BigNumber(result.takenOut), 'nas') + ' NAS');
                                }
                            }
                        } else {
                            submit.html("发起人暂未开放提款权限").prop('disabled', true);
                        }

                    } else if(action === 'takenOut'){
                        submit.html("已提款 " + Unit.fromBasic(result.takenOut, 'nas') + ' NAS').prop('disabled', true);
                    } else if(action === 'view'){
                        submit.html("已付款 " + Unit.fromBasic(result.paidAccs[address], 'nas') + ' NAS').prop('disabled', true);
                    } else{
                        action = 'pay';
                        submit.html("确认付款").prop('disabled', true);
                    }

                    if(result.canTakeOut){
                        $("#canTakeout").prop('checked', true);
                        canTakeout = true;
                    } else {
                        $("#canTakeout").prop('checked', false);
                        canTakeout = false;
                    }

                    if(addressWallet === result.initiatorAcc || address === result.initiatorAcc){
                        $("#canTakeout").prop('disabled', false).prop("onclick", null).off('click').click(function(){ setCanTakeout(parseInt(result.id), !canTakeout); });
                    }

                    if(parseInt(result.amount) == 0){
                        $("#unlimitedAmount").prop('checked', true);
                    } else {
                        $("#unlimitedAmount").prop('checked', false);
                    }

                    if(parseInt(result.splitNum) == 0){
                        $("#unconstrainedAmount").prop('checked', true);
                        if(action === 'pay'){
                            $("#unconstrainedPayAmount").prop('disabled', false);
                        }
                    } else {
                        $("#unconstrainedAmount").prop('checked', false);
                    }

                    var i = 0;
                    paidBill.html('');
                    for(var key in result.paidAccs){
                        i ++ ;
                        paidBillNum.html(i);
                        var skeleton = '<a class="pu rs xj ux" href="https://explorer.nebulas.io/#/address/{{account}}" target="_blank"><span>{{accountF}}...{{accountT}} {{memo}}</span><span class="awy">{{amount}} NAS</span></a>';
                        var data = {account: key, accountF: key.substring(0, 8), accountT: key.substring(key.length - 5, key.length), memo: result.paidAccMemos[key].substring(0, 5), amount: Unit.fromBasic(result.paidAccs[key], 'nas')};
                        var html = Mustache.to_html(skeleton, data);
                        paidBill.prepend(html);
                    }

                    callback()
                }catch (err){
                    //result is the error message
                    console.log("error:" + err.message)
                }

            }).catch(function (err) {
                //cbSearch(err)
                console.log("error:" + err.message)
            });

        });
    }


    var urlParams = new URLSearchParams(window.location.search);
    var index;
    var action;
    if(urlParams.has('address')){
        address = urlParams.get('address');
        if(!Account.isValidAddress(address)){
            address = '';
        }
    }
    if(urlParams.has('index')){
        index = urlParams.get('index');
        $("#paid-panel").prop('hidden', false);
        paidBill.toggle();
        if(urlParams.has('action')){
            action = urlParams.get('action');
            if(action === 'pay'){
                submit.html("确认付款").prop('disabled', true);
                $("#payAmountDiv").prop('hidden', false);
                $("#unconstrainedPayAmount").prop('disabled', true);
                $('#memoDiv').prop('hidden', false);
            } else if(action === 'takeout'){
                submit.html("确认提款").prop('disabled', true);
            } else if(action === 'takenOut'){
                submit.html("已提款").prop('disabled', true);
            } else if(action === 'view'){
                submit.html("已付款").prop('disabled', true);
            } else{
                action = 'pay';
                submit.html("确认付款").prop('disabled', true);
            }
        } else {
            action = 'pay';
            $("#payAmountDiv").prop('hidden', false);
            $("#unconstrainedPayAmount").prop('disabled', true);
            submit.html("确认付款").prop('disabled', true);
            $('#memoDiv').prop('hidden', false);
        }

        $("#billName").prop('readonly', true);
        $("#initiatorName").prop('readonly', true);
        $("#receiverName").prop('readonly', true);
        $("#receiverAcc").prop('readonly', true);
        $("#amount").prop('readonly', true);
        $("#num").prop('readonly', true);
        $("#canTakeout").prop('disabled', true);
        $("#unlimitedAmount").prop('disabled', true);
        $("#unconstrainedAmount").prop('disabled', true);

        window.addEventListener('message', function (e) {
            if (e.data.data && !!e.data.data.account) {
                if(address === '') address = e.data.data.account;
                addressWallet = e.data.data.account;
            }
            if(address !== ''){
                getSplitBill(index, function(){});
            }
        });

        window.postMessage({
            "target": "contentscript",
            "data": {},
            "method": "getAccount",
        }, "*");

        getSplitBill(index, function(){});
    } else{
        submit.html("确认收款");
    }

    getInitiatorBill();
    getReceiverBill();
    getTakerBill();
    getPayerBill();


</script>
</body>


<div id="noWallet" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">警告</h4>
            </div>
            <div class="modal-body">
                <p>检测到您未安装星云钱包插件。请使用谷歌(Chrome)浏览器并且安装<a href="https://github.com/ChengOrangeJu/WebExtensionWallet" target="_blank">星云钱包插件</a>。</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="disableCheckNASWallet()">
                    我已安装
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div id="noWalletMobile" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">警告</h4>
            </div>
            <div class="modal-body">
                <p>检测到您在移动端使用，请安装<a href="https://nano.nebulas.io" target="_blank">NAS nano</a>。</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="disableCheckNASWallet()">
                    我已安装
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<div id="invalidAddress" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">警告</h4>
            </div>
            <div class="modal-body">
                <p>星云账号地址格式错误！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<div id="invalidSearch" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">警告</h4>
            </div>
            <div class="modal-body">
                <p>请输入收款项编号或者正确的星云账号地址！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="packing" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>交易正在打包，请稍等十几秒钟。</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>

                <div class="btn btn-primary ld-ext-right running">正在打包交易...
                    <div class="ld ld-hourglass ld-spin-fast"></div>
                </div>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="packing_refresh" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>您使用的是移动客户端，请您手动刷新获取最新支付信息。</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>

                <div class="btn btn-primary ld-ext-right running">等待用户刷新
                    <div class="ld ld-hourglass ld-spin-fast"></div>
                </div>
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="refresh()">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="packing_success" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>交易打包成功！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="no_bill" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>不存在该收款项！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div id="fail" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>交易失败，请查询<a id="fail_link">交易信息</a>！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="query_overtime" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>交易查询超时，请查询<a id="query_link">交易信息</a>！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div id="confirm" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>正在调用钱包，请确认！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div id="reject" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">通知</h4>
            </div>
            <div class="modal-body">
                <p>您已取消！</p>
            </div>
            <div class="modal-footer" style="padding-top: 10px">
                <br>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

</html>
